<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte interactive des départements français</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    #sidebar {
      width: 280px;
      padding: 16px;
      box-sizing: border-box;
      border-right: 1px solid #ddd;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #map {
      flex: 1;
    }

    h1 {
      font-size: 18px;
      margin: 0 0 8px 0;
    }

    .info-box {
      font-size: 14px;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #ddd;
      min-height: 80px;
    }

    .info-label {
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 4px;
    }

    .info-main {
      font-size: 16px;
      font-weight: 600;
    }

    .info-sub {
      font-size: 13px;
      color: #555;
      margin-top: 4px;
    }

    .input-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    #deptInput {
      flex: 1;
      padding: 6px 8px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #222;
      background: #222;
      color: #fff;
      cursor: pointer;
    }

    button:hover {
      background: #000;
    }

    .hint {
      font-size: 11px;
      color: #777;
    }

    @media (max-width: 768px) {
      #app {
        flex-direction: column;
      }
      #sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>

<div id="app">
  <div id="sidebar">
    <h1>Carte des départements</h1>
    <div class="info-box" id="deptInfo">
      <div class="info-label">Département sélectionné</div>
      <div class="info-main">Aucun</div>
      <div class="info-sub">
        Clique ou touche un département sur la carte.<br>
        La distance affichée est une approximation centre du département → Marseille.
      </div>
    </div>

    <div>
      <div class="info-label">Surligner par code</div>
      <div class="input-row">
        <input
          id="deptInput"
          type="text"
          placeholder="Ex : 13, 26, 69"
        />
        <button id="btnHighlight">OK</button>
      </div>
      <div class="hint">
        Saisis un ou plusieurs codes (séparés par des virgules) pour les mettre en surbrillance.
      </div>
    </div>

    <div class="hint">
      • Survol / clic = surbrillance<br>
      • Clic = zoom + popup (nom, code, chef-lieu, distance)<br>
      • Compatible souris ou tactile.
    </div>
  </div>

  <div id="map"></div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // Coordonnées approximatives de Marseille
  const MARSEILLE = { lat: 43.2965, lng: 5.3698 };

  // Table des chefs-lieux (préfectures) par code de département
  // Métropole + DOM (971, 972, 973, 974, 976)
  const deptPrefectures = {
    "01": "Bourg-en-Bresse",
    "02": "Laon",
    "03": "Moulins",
    "04": "Digne-les-Bains",
    "05": "Gap",
    "06": "Nice",
    "07": "Privas",
    "08": "Charleville-Mézières",
    "09": "Foix",
    "10": "Troyes",
    "11": "Carcassonne",
    "12": "Rodez",
    "13": "Marseille",
    "14": "Caen",
    "15": "Aurillac",
    "16": "Angoulême",
    "17": "La Rochelle",
    "18": "Bourges",
    "19": "Tulle",
    "21": "Dijon",
    "22": "Saint-Brieuc",
    "23": "Guéret",
    "24": "Périgueux",
    "25": "Besançon",
    "26": "Valence",
    "27": "Évreux",
    "28": "Chartres",
    "29": "Quimper",
    "2A": "Ajaccio",
    "2B": "Bastia",
    "30": "Nîmes",
    "31": "Toulouse",
    "32": "Auch",
    "33": "Bordeaux",
    "34": "Montpellier",
    "35": "Rennes",
    "36": "Châteauroux",
    "37": "Tours",
    "38": "Grenoble",
    "39": "Lons-le-Saunier",
    "40": "Mont-de-Marsan",
    "41": "Blois",
    "42": "Saint-Étienne",
    "43": "Le Puy-en-Velay",
    "44": "Nantes",
    "45": "Orléans",
    "46": "Cahors",
    "47": "Agen",
    "48": "Mende",
    "49": "Angers",
    "50": "Saint-Lô",
    "51": "Châlons-en-Champagne",
    "52": "Chaumont",
    "53": "Laval",
    "54": "Nancy",
    "55": "Bar-le-Duc",
    "56": "Vannes",
    "57": "Metz",
    "58": "Nevers",
    "59": "Lille",
    "60": "Beauvais",
    "61": "Alençon",
    "62": "Arras",
    "63": "Clermont-Ferrand",
    "64": "Pau",
    "65": "Tarbes",
    "66": "Perpignan",
    "67": "Strasbourg",
    "68": "Colmar",
    "69": "Lyon",
    "70": "Vesoul",
    "71": "Mâcon",
    "72": "Le Mans",
    "73": "Chambéry",
    "74": "Annecy",
    "75": "Paris",
    "76": "Rouen",
    "77": "Melun",
    "78": "Versailles",
    "79": "Niort",
    "80": "Amiens",
    "81": "Albi",
    "82": "Montauban",
    "83": "Toulon",
    "84": "Avignon",
    "85": "La Roche-sur-Yon",
    "86": "Poitiers",
    "87": "Limoges",
    "88": "Épinal",
    "89": "Auxerre",
    "90": "Belfort",
    "91": "Évry-Courcouronnes",
    "92": "Nanterre",
    "93": "Bobigny",
    "94": "Créteil",
    "95": "Pontoise",
    "971": "Basse-Terre",
    "972": "Fort-de-France",
    "973": "Cayenne",
    "974": "Saint-Denis",
    "976": "Mamoudzou"
  };

  // Styles de base
  const defaultStyle = {
    color: "#555",
    weight: 1,
    fillColor: "#e0e0e0",
    fillOpacity: 0.7
  };

  const highlightStyle = {
    color: "#000",
    weight: 2,
    fillColor: "#ffcc00",
    fillOpacity: 0.9
  };

  // Création de la carte
  const map = L.map("map", {
    zoomSnap: 0.5,
    zoomControl: true
  }).setView([46.7, 2.5], 5.8); // centre de la France

  // Fond de carte OpenStreetMap
  L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  let geojsonLayer = null;

  // Haversine pour distance en km
  function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  // Centroid approximatif (moyenne des points)
  function getCentroid(feature) {
    const geom = feature.geometry;
    let coords = [];

    if (geom.type === "Polygon") {
      coords = geom.coordinates[0];
    } else if (geom.type === "MultiPolygon") {
      geom.coordinates.forEach(poly => {
        coords = coords.concat(poly[0]);
      });
    }

    let sumLat = 0;
    let sumLng = 0;

    coords.forEach(c => {
      const lng = c[0];
      const lat = c[1];
      sumLat += lat;
      sumLng += lng;
    });

    const n = coords.length || 1;
    return {
      lat: sumLat / n,
      lng: sumLng / n
    };
  }

  // Mise à jour de la box de gauche
  function updateSidebarInfo(name, code, distKmApprox, prefecture) {
    const box = document.getElementById("deptInfo");
    const main = box.querySelector(".info-main");
    const sub = box.querySelector(".info-sub");

    if (!name) {
      main.textContent = "Aucun";
      sub.innerHTML = "Clique ou touche un département sur la carte.";
      return;
    }

    main.textContent = `${name} (${code})`;
    sub.innerHTML =
      `Chef-lieu : <b>${prefecture}</b><br>` +
      `Distance approximative du centre du département à Marseille : ` +
      `<b>${distKmApprox.toFixed(0)} km</b>.`;
  }

  function onEachFeature(feature, layer) {
    const props = feature.properties || {};
    const code = props.code;
    const name = props.nom;

    const centroid = getCentroid(feature);
    const dist = distanceKm(
      MARSEILLE.lat,
      MARSEILLE.lng,
      centroid.lat,
      centroid.lng
    );

    const prefecture = deptPrefectures[code] || "Chef-lieu non renseigné";

    // Stockage interne
    layer._deptCode = code;
    layer._deptName = name;
    layer._deptDistance = dist;
    layer._deptPrefecture = prefecture;

    const popupHtml =
      `<b>${name}</b> (${code})<br>` +
      `Chef-lieu : <b>${prefecture}</b><br>` +
      `Centre → Marseille ≈ ${dist.toFixed(0)} km`;

    layer.bindPopup(popupHtml);

    layer.on({
      mouseover: e => {
        const l = e.target;
        l.setStyle(highlightStyle);
        l.bringToFront();
        updateSidebarInfo(name, code, dist, prefecture);
      },
      mouseout: e => {
        geojsonLayer.resetStyle(e.target);
      },
      click: e => {
        const l = e.target;
        l.setStyle(highlightStyle);
        l.bringToFront();
        updateSidebarInfo(name, code, dist, prefecture);
        map.fitBounds(l.getBounds(), { maxZoom: 9 });
        l.openPopup();
      }
    });
  }

  // GeoJSON des départements (projet open-source France GeoJSON)
  const geojsonUrl =
    "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements-version-simplifiee.geojson";

  fetch(geojsonUrl)
    .then(res => res.json())
    .then(data => {
      geojsonLayer = L.geoJSON(data, {
        style: () => defaultStyle,
        onEachFeature: onEachFeature
      }).addTo(map);
    })
    .catch(err => {
      console.error("Erreur lors du chargement du GeoJSON :", err);
      alert("Impossible de charger la carte des départements.");
    });

  // Surlignage par saisie de codes
  function highlightFromInput() {
    const input = document.getElementById("deptInput").value;
    if (!geojsonLayer || !input) return;

    const codes = input
      .split(",")
      .map(c => c.trim())
      .filter(c => c.length > 0);

    geojsonLayer.eachLayer(layer => {
      geojsonLayer.resetStyle(layer);
    });

    geojsonLayer.eachLayer(layer => {
      if (codes.includes(layer._deptCode)) {
        layer.setStyle(highlightStyle);
        layer.bringToFront();
      }
    });
  }

  document
    .getElementById("btnHighlight")
    .addEventListener("click", highlightFromInput);

  document
    .getElementById("deptInput")
    .addEventListener("keydown", e => {
      if (e.key === "Enter") {
        highlightFromInput();
      }
    });
</script>

</body>
</html>
